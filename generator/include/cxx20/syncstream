#pragma once

#include <mutex>
#include <sstream>
#include <unordered_map>

namespace cxx20 {

// will become available in C++ 20
struct osyncstream : public std::ostringstream
{
  explicit osyncstream(std::ostream& output_stream)
  : output(output_stream)
  {
  }
  ~osyncstream()
  {
    emit();
  }

  void emit()
  {
    std::ostringstream const tmp{ std::move(*this) };

    static std::unordered_map<std::ostream*, std::mutex> locks;

    auto const locked = std::scoped_lock{ locks[&output] };
    output << tmp.str();
  }

private:
  std::ostream& output;
};

} // namespace cxx20

